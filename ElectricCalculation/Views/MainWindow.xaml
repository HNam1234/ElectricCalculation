<Window x:Class="ElectricCalculation.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:ElectricCalculation.ViewModels"
        xmlns:behaviors="clr-namespace:ElectricCalculation.Behaviors"
        xmlns:helpers="clr-namespace:ElectricCalculation.Helpers"
        mc:Ignorable="d"
        Title="Electric Calculation"
        Height="720"
        Width="1280"
        WindowStartupLocation="CenterScreen"
        Closing="MainWindow_Closing"
        behaviors:ShortcutFocusBehavior.Key="F"
        behaviors:ShortcutFocusBehavior.Modifiers="Control"
        behaviors:ShortcutFocusBehavior.Target="{Binding ElementName=SearchTextBox}">
    <Window.DataContext>
        <vm:MainWindowViewModel />
    </Window.DataContext>

    <Window.Resources>
        <helpers:BindingProxy x:Key="VmProxy" Data="{Binding}" />
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />

        <SolidColorBrush x:Key="AccentBrush" Color="#2563EB" />
        <SolidColorBrush x:Key="AccentBrushDark" Color="#1D4ED8" />
        <SolidColorBrush x:Key="SurfaceBorderBrush" Color="#FFE5E7EB" />
        <SolidColorBrush x:Key="TextMutedBrush" Color="#FF475569" />
        <SolidColorBrush x:Key="TextPrimaryBrush" Color="#FF111827" />

        <Style x:Key="ModeToggleButtonStyle" TargetType="{x:Type ToggleButton}">
            <Setter Property="Height" Value="30" />
            <Setter Property="MinWidth" Value="180" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ToggleButton}">
                        <Border x:Name="OuterBorder"
                                CornerRadius="15"
                                BorderBrush="{StaticResource SurfaceBorderBrush}"
                                BorderThickness="1"
                                Background="#FFF1F5F9"
                                SnapsToDevicePixels="True">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <Border x:Name="LeftSegment"
                                        Grid.Column="0"
                                        CornerRadius="15,0,0,15"
                                        Background="#FFDBEAFE" />
                                <Border x:Name="RightSegment"
                                        Grid.Column="1"
                                        CornerRadius="0,15,15,0"
                                        Background="Transparent" />

                                <TextBlock x:Name="LeftText"
                                           Grid.Column="0"
                                           Text="Nhập nhanh"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource TextPrimaryBrush}" />
                                <TextBlock x:Name="RightText"
                                           Grid.Column="1"
                                           Text="Chi tiết"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource TextPrimaryBrush}" />
                            </Grid>
                        </Border>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="False">
                                <Setter TargetName="LeftSegment" Property="Background" Value="Transparent" />
                                <Setter TargetName="RightSegment" Property="Background" Value="#FFDBEAFE" />
                                <Setter TargetName="LeftText" Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                <Setter TargetName="RightText" Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                            </Trigger>

                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="OuterBorder" Property="BorderBrush" Value="{StaticResource AccentBrushDark}" />
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DataGridColumnHeaderBaseStyle" TargetType="{x:Type DataGridColumnHeader}">
            <Setter Property="Padding" Value="6,4" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
            <Setter Property="ContentTemplate">
                <Setter.Value>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Center">
                            <Border x:Name="FastEntryMarker"
                                    Width="3"
                                    Height="14"
                                    CornerRadius="2"
                                    Background="{StaticResource AccentBrush}"
                                    Margin="0,0,6,0"
                                    Visibility="Collapsed" />
                            <TextBlock Text="{Binding}"
                                       TextAlignment="Center"
                                       TextWrapping="NoWrap"
                                       TextTrimming="CharacterEllipsis"
                                       ToolTip="{Binding}" />
                        </StackPanel>

                        <DataTemplate.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding}" Value="Chỉ số mới" />
                                    <Condition Binding="{Binding Data.IsFastEntryMode, Source={StaticResource VmProxy}}" Value="True" />
                                </MultiDataTrigger.Conditions>
                                <Setter TargetName="FastEntryMarker" Property="Visibility" Value="Visible" />
                            </MultiDataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FilterToggleButtonStyle" TargetType="{x:Type ToggleButton}">
            <Setter Property="MinWidth" Value="72" />
            <Setter Property="Height" Value="30" />
            <Setter Property="Padding" Value="12,0" />
            <Setter Property="Margin" Value="8,0,0,0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ToggleButton}">
                        <Border x:Name="Outer"
                                CornerRadius="8"
                                BorderThickness="1"
                                BorderBrush="{StaticResource SurfaceBorderBrush}"
                                Background="#FFF1F5F9"
                                SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Outer" Property="BorderBrush" Value="{StaticResource AccentBrushDark}" />
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Outer" Property="Background" Value="#FFDBEAFE" />
                                <Setter TargetName="Outer" Property="BorderBrush" Value="{StaticResource AccentBrush}" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding Key="S" Modifiers="Control" Command="{Binding SaveSnapshotCommand}" />
        <KeyBinding Key="Enter" Modifiers="Control" Command="{Binding AddRowCommand}" />
        <KeyBinding Key="Z" Modifiers="Control" Command="{Binding UndoCommand}" />
        <KeyBinding Key="Y" Modifiers="Control" Command="{Binding RedoCommand}" />
    </Window.InputBindings>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Menu Grid.Row="0" Margin="0,0,0,8">
            <MenuItem Header="_Tệp">
                <MenuItem Header="Mở dữ liệu..."
                          Command="{Binding OpenDataFileWithDialogCommand}" />
                <MenuItem Header="Trang chủ"
                          Click="BackToHome_Click" />
                <MenuItem Header="Lưu dữ liệu..."
                          Command="{Binding SaveDataFileWithDialogCommand}" />
                <MenuItem Header="Bộ dữ liệu: Lưu nhanh"
                          Command="{Binding SaveSnapshotCommand}" />
                <MenuItem Header="Bộ dữ liệu: Mở..."
                          Command="{Binding OpenSnapshotWithDialogCommand}" />
                <MenuItem Header="Bộ dữ liệu: Mở thư mục"
                          Command="{Binding OpenSnapshotFolderCommand}" />
                <Separator />
                <MenuItem Header="Import từ Excel..."
                          Command="{Binding ImportFromExcelWithDialogCommand}" />
                <MenuItem Header="Export bảng kê ra Excel..."
                          Command="{Binding ExportToExcelWithDialogCommand}" />
            </MenuItem>

            <MenuItem Header="_Sửa">
                <MenuItem Header="Undo (Ctrl+Z)"
                          Command="{Binding UndoCommand}" />
                <MenuItem Header="Redo (Ctrl+Y)"
                          Command="{Binding RedoCommand}" />
                <MenuItem Header="Lịch sử chỉnh sửa..."
                          Command="{Binding ShowEditHistoryCommand}" />
                <MenuItem Header="Nhập nhanh"
                          IsCheckable="True"
                          IsChecked="{Binding IsFastEntryMode, Mode=TwoWay}" />
                <Separator />
                <MenuItem Header="Nhân đôi dòng (Ctrl+Shift+D)"
                          Command="{Binding DuplicateRowCommand}"
                          CommandParameter="{Binding SelectedItem, ElementName=CustomerGrid}" />
                <MenuItem Header="Xóa dòng đang chọn (Del)"
                          Command="{Binding DeleteSelectedRowsCommand}"
                          CommandParameter="{Binding SelectedItems, ElementName=CustomerGrid}" />
            </MenuItem>

            <MenuItem Header="_Kỳ">
                <MenuItem Header="Làm tháng mới..."
                          Command="{Binding NewPeriodWithDialogCommand}" />
            </MenuItem>

            <MenuItem Header="_Xuất / In">
                <MenuItem Header="Xuất hóa đơn (PDF)..."
                          Command="{Binding PrintInvoicePdfWithDialogCommand}" />
                <MenuItem Header="Xuất nhiều hóa đơn (PDF)..."
                          Command="{Binding PrintMultipleInvoicesPdfWithDialogCommand}"
                          CommandParameter="{Binding SelectedItems, ElementName=CustomerGrid}" />
                <Separator />
                <MenuItem Header="Xuất hóa đơn (Excel)..."
                          Command="{Binding PrintInvoiceWithDialogCommand}" />
                <MenuItem Header="Xuất nhiều hóa đơn (Excel)..."
                          Command="{Binding PrintMultipleInvoicesWithDialogCommand}"
                          CommandParameter="{Binding SelectedItems, ElementName=CustomerGrid}" />
                <MenuItem Header="Xuất hóa đơn theo số..."
                          Command="{Binding PrintInvoicesByRangeWithDialogCommand}" />
            </MenuItem>

            <MenuItem Header="_Báo cáo">
                <MenuItem Header="Thống kê theo nhóm..."
                          Command="{Binding ShowReportCommand}" />
            </MenuItem>
        </Menu>

        <StackPanel Grid.Row="1" Margin="0,0,0,8">
            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Disabled"
                          CanContentScroll="True">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0"
                                Orientation="Horizontal"
                                VerticalAlignment="Center">
                        <Button Content="Trang chủ"
                                Padding="12,4"
                                Margin="0,0,16,0"
                                Click="BackToHome_Click" />

                        <TextBlock Text="Kỳ tính:"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0" />
                        <TextBox Width="150"
                                 VerticalAlignment="Center"
                                 Text="{Binding PeriodLabel, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <Button Content="Thêm dòng"
                                Margin="16,0,0,0"
                                Padding="12,4"
                                Command="{Binding AddRowCommand}" />

                        <TextBlock Text="Người lập đơn:"
                                   VerticalAlignment="Center"
                                   Margin="24,0,4,0" />
                        <TextBox Width="160"
                                 VerticalAlignment="Center"
                                 Text="{Binding InvoiceIssuer, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <TextBlock Text="Tìm:"
                                   VerticalAlignment="Center"
                                   Margin="24,0,4,0" />
                        <ComboBox Width="150"
                                  ItemsSource="{Binding SearchFields}"
                                  SelectedItem="{Binding SelectedSearchField, Mode=TwoWay}"
                                  VerticalAlignment="Center" />
                        <TextBox x:Name="SearchTextBox"
                                 Width="220"
                                 Margin="4,0,0,0"
                                 VerticalAlignment="Center"
                                 Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                    </StackPanel>

                    <StackPanel Grid.Row="1"
                                Orientation="Horizontal"
                                VerticalAlignment="Center"
                                Margin="0,6,0,0">
                        <TextBlock Text="Chế độ:"
                                   VerticalAlignment="Center"
                                   Margin="0,0,4,0" />
                        <ToggleButton Style="{StaticResource ModeToggleButtonStyle}"
                                      ToolTip="Nhập nhanh: khóa vào cột Chỉ số mới. Enter để xuống dòng."
                                      IsChecked="{Binding IsFastEntryMode, Mode=TwoWay}" />

                        <CheckBox Content="Nhập theo tuyến"
                                  Margin="12,0,0,0"
                                  VerticalAlignment="Center"
                                  IsChecked="{Binding IsRouteEntryMode, Mode=TwoWay}" />

                        <TextBlock Text="Lọc:"
                                   Margin="24,0,4,0"
                                   VerticalAlignment="Center" />
                        <ToggleButton Content="Thiếu"
                                      Style="{StaticResource FilterToggleButtonStyle}"
                                      ToolTip="Chỉ hiện khách thiếu chỉ số mới"
                                      IsChecked="{Binding FilterMissing, Mode=TwoWay}" />
                        <ToggleButton Content="Cảnh báo"
                                      Style="{StaticResource FilterToggleButtonStyle}"
                                      ToolTip="Chỉ hiện khách có cảnh báo kWh tăng cao"
                                      IsChecked="{Binding FilterWarning, Mode=TwoWay}" />
                        <ToggleButton Content="Lỗi"
                                      Style="{StaticResource FilterToggleButtonStyle}"
                                      ToolTip="Chỉ hiện khách có lỗi chỉ số"
                                      IsChecked="{Binding FilterError, Mode=TwoWay}" />
                    </StackPanel>
                </Grid>
            </ScrollViewer>

            <Border Background="#EFF6FF"
                    BorderBrush="{StaticResource AccentBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="8"
                    Margin="0,8,0,0"
                    Visibility="{Binding IsFastEntryMode, Converter={StaticResource BoolToVisibility}}">
                <TextBlock TextWrapping="Wrap">
                    <Run Text="NHẬP NHANH: " FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}" />
                    <Run Text="nhập chỉ số ở cột " />
                    <Run Text="Chỉ số mới" FontWeight="SemiBold" />
                    <Run Text=", nhấn " />
                    <Run Text="Enter" FontWeight="SemiBold" />
                    <Run Text=" để xuống dòng. Chuyển sang " />
                    <Run Text="Chi tiết" FontWeight="SemiBold" />
                    <Run Text=" để thoát nhập nhanh." />
                </TextBlock>
            </Border>

        </StackPanel>

        <DataGrid x:Name="CustomerGrid"
                  Grid.Row="2"
                  ItemsSource="{Binding CustomersView}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  IsReadOnly="False"
                  CanUserReorderColumns="True"
                  CanUserResizeColumns="True"
                  MinColumnWidth="70"
                  ColumnHeaderHeight="34"
                  FrozenColumnCount="2"
                  EnableRowVirtualization="True"
                  EnableColumnVirtualization="True"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  ScrollViewer.CanContentScroll="True"
                  ScrollViewer.HorizontalScrollBarVisibility="Auto"
                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                  ScrollViewer.IsDeferredScrollingEnabled="False"
                  SelectionMode="Extended"
                  behaviors:DataGridEditHistoryBehavior.TrackCellEditCommand="{Binding TrackCellEditCommand}"
                  behaviors:DataGridEditHistoryBehavior.PasteFromClipboardCommand="{Binding PasteFromClipboardCommand}"
                  behaviors:DataGridEditHistoryBehavior.FillDownCommand="{Binding FillDownCommand}"
                  behaviors:DataGridEditHistoryBehavior.DeleteSelectedRowsCommand="{Binding DeleteSelectedRowsCommand}"
                  behaviors:DataGridEditHistoryBehavior.DuplicateRowCommand="{Binding DuplicateRowCommand}"
                  behaviors:DataGridEnterToNextRowBehavior.IsEnabled="True"
                  behaviors:DataGridEnterToNextRowBehavior.TargetPropertyName="CurrentIndex"
                  behaviors:DataGridEnterToNextRowBehavior.SelectAllOnEdit="True"
                  behaviors:DataGridFastEntryLockBehavior.IsEnabled="{Binding IsFastEntryMode}"
                  behaviors:DataGridFastEntryLockBehavior.TargetPropertyName="CurrentIndex"
                  SelectedItem="{Binding SelectedCustomer, Mode=TwoWay}">
            <DataGrid.Style>
                <Style TargetType="{x:Type DataGrid}">
                    <Setter Property="CanUserSortColumns" Value="True" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsRouteEntryMode}" Value="True">
                            <Setter Property="CanUserSortColumns" Value="False" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.Style>
            <DataGrid.CellStyle>
                <Style TargetType="{x:Type DataGridCell}">
                    <Setter Property="Padding" Value="6,2" />
                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="#FFDBEAFE" />
                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.CellStyle>

            <DataGrid.RowStyle>
                <Style TargetType="{x:Type DataGridRow}">
                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUsageWarning}" Value="True">
                            <Setter Property="Background" Value="#FFFFEDD5" />
                        </DataTrigger>
                        <DataTrigger Binding="{Binding HasReadingError}" Value="True">
                            <Setter Property="Background" Value="#FFFEE2E2" />
                        </DataTrigger>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="#FFDBEAFE" />
                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.RowStyle>

            <DataGrid.ColumnHeaderStyle>
                <Style TargetType="{x:Type DataGridColumnHeader}"
                       BasedOn="{StaticResource DataGridColumnHeaderBaseStyle}" />
            </DataGrid.ColumnHeaderStyle>

            <DataGrid.ContextMenu>
                <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                    <MenuItem Header="Undo (Ctrl+Z)"
                              Command="{Binding UndoCommand}" />
                    <MenuItem Header="Redo (Ctrl+Y)"
                              Command="{Binding RedoCommand}" />
                    <Separator />
                    <MenuItem Header="Nhân đôi dòng (Ctrl+Shift+D)"
                              Command="{Binding DuplicateRowCommand}"
                              CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                    <MenuItem Header="Xóa dòng đang chọn (Del)"
                              Command="{Binding DeleteSelectedRowsCommand}"
                              CommandParameter="{Binding PlacementTarget.SelectedItems, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                </ContextMenu>
            </DataGrid.ContextMenu>

            <DataGrid.Columns>
                <DataGridTextColumn Header="Số phiếu"
                                    Binding="{Binding SequenceNumber, UpdateSourceTrigger=PropertyChanged}"
                                    IsReadOnly="True"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="78"
                                    MinWidth="78" />
                <DataGridTextColumn Header="Tên khách"
                                    Binding="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                    Width="2*"
                                    MinWidth="220" />
                <DataGridTextColumn Header="Nhóm / Đơn vị"
                                    Binding="{Binding GroupName, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="1.2*"
                                    MinWidth="180" />
                <DataGridTextColumn Header="Loại"
                                    Binding="{Binding Category, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="90" />
                <DataGridTextColumn Header="Địa chỉ"
                                    Binding="{Binding Address, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="2.2*"
                                    MinWidth="260" />
                <DataGridTextColumn Header="SĐT hộ"
                                    Binding="{Binding HouseholdPhone, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="110" />
                <DataGridTextColumn Header="Đại diện"
                                    Binding="{Binding RepresentativeName, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="160" />
                <DataGridTextColumn Header="SĐT"
                                    Binding="{Binding Phone, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="110" />
                <DataGridTextColumn Header="Tòa / Mã sổ"
                                    Binding="{Binding BuildingName, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="110" />
                <DataGridTextColumn Header="Công tơ"
                                    Binding="{Binding MeterNumber, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="110" />
                <DataGridTextColumn Header="Vị trí"
                                    Binding="{Binding Location, UpdateSourceTrigger=PropertyChanged}"
                                    Width="100" />
                <DataGridTextColumn Header="TBA"
                                    Binding="{Binding Substation, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="95" />
                <DataGridTextColumn Header="Trang"
                                    Binding="{Binding Page, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="70" />
                <DataGridTextColumn Header="Chỉ số cũ"
                                    Binding="{Binding PreviousIndex, UpdateSourceTrigger=PropertyChanged}"
                                    IsReadOnly="True"
                                    Width="100" />
                <DataGridTextColumn Header="Chỉ số mới"
                                    Binding="{Binding CurrentIndex, UpdateSourceTrigger=PropertyChanged}"
                                    Width="100">
                     <DataGridTextColumn.CellStyle>
                         <Style TargetType="{x:Type DataGridCell}">
                             <Setter Property="Padding" Value="6,2" />
                             <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                              <Style.Triggers>
                                  <DataTrigger Binding="{Binding IsMissingReading}" Value="True">
                                      <Setter Property="Background" Value="#FFFEF3C7" />
                                  </DataTrigger>
                                  <DataTrigger Binding="{Binding IsZeroUsage}" Value="True">
                                      <Setter Property="Background" Value="#FFE0F2FE" />
                                  </DataTrigger>
                                  <Trigger Property="IsSelected" Value="True">
                                      <Setter Property="Background" Value="#FFDBEAFE" />
                                  </Trigger>
                              </Style.Triggers>
                          </Style>
                      </DataGridTextColumn.CellStyle>
                      <DataGridTextColumn.EditingElementStyle>
                           <Style TargetType="{x:Type TextBox}">
                               <Setter Property="VerticalContentAlignment" Value="Center" />
                               <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                               <Style.Triggers>
                                   <DataTrigger Binding="{Binding Data.IsFastEntryMode, Source={StaticResource VmProxy}}" Value="True">
                                       <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}" />
                                       <Setter Property="BorderThickness" Value="2" />
                                      <Setter Property="Background" Value="#EEF2FF" />
                                  </DataTrigger>
                                  <DataTrigger Binding="{Binding IsMissingReading}" Value="True">
                                      <Setter Property="Background" Value="#FFFEF3C7" />
                                  </DataTrigger>
                                  <DataTrigger Binding="{Binding IsZeroUsage}" Value="True">
                                     <Setter Property="Background" Value="#FFE0F2FE" />
                                 </DataTrigger>
                             </Style.Triggers>
                         </Style>
                     </DataGridTextColumn.EditingElementStyle>
                 </DataGridTextColumn>
                <DataGridTextColumn Header="Hệ số"
                                    Binding="{Binding Multiplier, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="80" />
                <DataGridTextColumn Header="Bao cấp (kWh)"
                                    Binding="{Binding SubsidizedKwh, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="110" />
                <DataGridTextColumn Header="Đơn giá"
                                    Binding="{Binding UnitPrice, UpdateSourceTrigger=PropertyChanged}"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="110" />
                <DataGridTextColumn Header="kWh"
                                    Binding="{Binding Consumption, StringFormat=N0}"
                                    IsReadOnly="True"
                                    Width="90" />
                <DataGridTextColumn Header="kWh tính tiền"
                                    Binding="{Binding ChargeableKwh, StringFormat=N0}"
                                    IsReadOnly="True"
                                    Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                    Width="120" />
                <DataGridTextColumn Header="Thành tiền"
                                    Binding="{Binding Amount, StringFormat=N0}"
                                    IsReadOnly="True"
                                    Width="140" />
                <DataGridTemplateColumn Header="Trạng thái"
                                        IsReadOnly="True"
                                        Width="150">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal"
                                        VerticalAlignment="Center"
                                        ToolTip="{Binding StatusTooltip}">
                                <Ellipse Width="10" Height="10" Margin="0,0,6,0">
                                    <Ellipse.Style>
                                        <Style TargetType="{x:Type Ellipse}">
                                            <Setter Property="Fill" Value="#22C55E" />
                                            <Style.Triggers>
                                                 <DataTrigger Binding="{Binding IsMissingReading}" Value="True">
                                                     <Setter Property="Fill" Value="#F59E0B" />
                                                 </DataTrigger>
                                                 <DataTrigger Binding="{Binding IsZeroUsage}" Value="True">
                                                     <Setter Property="Fill" Value="#3B82F6" />
                                                 </DataTrigger>
                                                 <DataTrigger Binding="{Binding HasUsageWarning}" Value="True">
                                                     <Setter Property="Fill" Value="#F97316" />
                                                 </DataTrigger>
                                                <DataTrigger Binding="{Binding HasReadingError}" Value="True">
                                                    <Setter Property="Fill" Value="#EF4444" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                                <TextBlock Text="{Binding StatusText}" />
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn Header="Người ghi"
                                      Binding="{Binding PerformedBy, UpdateSourceTrigger=PropertyChanged}"
                                      Visibility="{Binding Data.IsDetailMode, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVisibility}}"
                                      Width="150" />
            </DataGrid.Columns>
        </DataGrid>

        <Border Grid.Row="3"
                Background="#FFF8FAFC"
                BorderBrush="#FFE5E7EB"
                BorderThickness="1"
                CornerRadius="8"
                Padding="10"
                Margin="0,8,0,0">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding RouteEntryProgressText}"
                           Width="260"
                           TextTrimming="CharacterEllipsis"
                           ToolTip="{Binding RouteEntryProgressText}"
                           Visibility="{Binding IsRouteEntryMode, Converter={StaticResource BoolToVisibility}}"
                           Margin="0,0,16,0" />
                <TextBlock Text="{Binding CustomerCount, StringFormat=Tổng: {0}}" />
                <TextBlock Text="{Binding CompletedCount, StringFormat=  |  Đã nhập: {0}}"
                           Margin="16,0,0,0" />
                <TextBlock Text="{Binding MissingCount, StringFormat=  |  Thiếu: {0}}"
                           Margin="16,0,0,0" />
                <TextBlock Text="{Binding WarningCount, StringFormat=  |  Cảnh báo: {0}}"
                           Margin="16,0,0,0" />
                <TextBlock Text="{Binding ErrorCount, StringFormat=  |  Lỗi: {0}}"
                           Margin="16,0,0,0" />
                <ProgressBar Width="120"
                             Height="12"
                             Margin="16,0,0,0"
                               VerticalAlignment="Center"
                               Minimum="0"
                               Maximum="1"
                              Value="{Binding CompletionRatio, Mode=OneWay}" />
                <TextBlock Text="{Binding TotalConsumption, StringFormat=  |  Tổng kWh: {0:N0}}"
                           Margin="16,0,0,0" />
                <TextBlock Text="{Binding TotalChargeableKwh, StringFormat=  |  kWh tính tiền: {0:N0}}"
                           Margin="16,0,0,0" />
                <TextBlock Text="{Binding TotalAmount, StringFormat=  |  Tổng tiền: {0:N0}}"
                           Margin="16,0,0,0" />
            </StackPanel>
        </Border>
    </Grid>
</Window>
